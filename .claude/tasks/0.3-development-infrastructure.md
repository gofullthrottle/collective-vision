# Epic 0.3: Development Infrastructure

## Methodology Guidance
**SPECTRA Phase**: Foundation/Hardening
**Approach**: Developer experience first - testing, environments, CI/CD
**Tools**: Vitest, Wrangler, GitHub Actions

## Wave Context
**Wave**: 0 - Foundation Hardening
**Priority**: Critical (enables quality development going forward)
**Dependencies**: None
**Estimated Duration**: 4 hours

## Quality Requirements
- New developers can set up in < 15 minutes
- Tests run on every PR
- Clear environment separation (dev/staging/production)
- Local development mirrors production behavior

---

## Tasks

### 0.3.1 Test Setup (1.5h)
**Objective**: Establish testing infrastructure for Workers environment

**Steps**:
1. Install Vitest and dependencies:
   ```bash
   npm install -D vitest @cloudflare/vitest-pool-workers miniflare
   ```
2. Configure vitest for Workers:
   ```typescript
   // vitest.config.ts
   import { defineWorkersConfig } from '@cloudflare/vitest-pool-workers/config';

   export default defineWorkersConfig({
     test: {
       poolOptions: {
         workers: {
           wrangler: { configPath: './wrangler.toml' }
         }
       }
     }
   });
   ```
3. Create test utilities:
   ```typescript
   // tests/utils.ts
   export function createMockD1() { ... }
   export function createMockRequest(path: string, options?: RequestInit) { ... }
   ```
4. Write first API endpoint tests:
   - Health check endpoint
   - Create feedback endpoint
   - Vote endpoint
5. Configure test coverage reporting

**Acceptance Criteria**:
- [ ] `npm test` runs successfully
- [ ] At least 3 endpoint tests passing
- [ ] Coverage report generates
- [ ] Mock utilities documented

---

### 0.3.2 Environment Configuration (1h)
**Objective**: Clear separation of dev/staging/production environments

**Steps**:
1. Create environment-specific wrangler configs:
   ```toml
   # wrangler.toml
   [env.staging]
   name = "collective-vision-staging"
   [[env.staging.d1_databases]]
   binding = "DB"
   database_name = "collective-vision-staging"
   database_id = "staging-db-id"

   [env.production]
   name = "collective-vision"
   # ... production config
   ```
2. Document all environment variables:
   - `ENVIRONMENT` - dev/staging/production
   - `CLAUDE_API_KEY` - For AI features (Wave 2)
   - `RESEND_API_KEY` - For email (Wave 1)
3. Create `.env.example`:
   ```
   # Local development
   ENVIRONMENT=development

   # AI Features (Wave 2)
   CLAUDE_API_KEY=sk-ant-xxx

   # Email (Wave 1)
   RESEND_API_KEY=re_xxx
   ```
4. Add secrets management documentation

**Acceptance Criteria**:
- [ ] Clear separation of environments in wrangler.toml
- [ ] All environment variables documented
- [ ] `.env.example` created
- [ ] Secrets storage documented

---

### 0.3.3 Local Development Improvements (1h)
**Objective**: Streamlined local development experience

**Steps**:
1. Document complete local setup in `CONTRIBUTING.md`:
   ```markdown
   ## Quick Start
   1. Clone repository
   2. npm install
   3. Copy `.env.example` to `.env`
   4. npm run db:setup
   5. npm run dev
   ```
2. Create seed data script:
   ```typescript
   // scripts/seed.ts
   async function seed() {
     // Create test workspace
     // Create test board
     // Create sample feedback
     // Create test user
   }
   ```
3. Add npm scripts:
   ```json
   {
     "scripts": {
       "dev": "wrangler dev",
       "db:setup": "wrangler d1 execute collective-vision-feedback --file=schema.sql --local",
       "db:seed": "tsx scripts/seed.ts",
       "db:reset": "npm run db:setup && npm run db:seed"
     }
   }
   ```
4. Create development widget test page:
   ```html
   <!-- test/widget-test.html -->
   <script src="http://localhost:8787/widget.js" data-workspace="test" data-board="main"></script>
   ```

**Acceptance Criteria**:
- [ ] New developer can set up in < 15 minutes
- [ ] Seed data script creates realistic test data
- [ ] Widget test page works locally
- [ ] Hot-reload working for development

---

### 0.3.4 CI/CD Foundation (0.5h)
**Objective**: Automated testing and deployment pipelines

**Steps**:
1. Create GitHub Actions workflow for tests:
   ```yaml
   # .github/workflows/test.yml
   name: Test
   on: [pull_request]
   jobs:
     test:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-node@v4
         - run: npm ci
         - run: npm test
   ```
2. Create staging deployment workflow:
   ```yaml
   # .github/workflows/deploy-staging.yml
   name: Deploy Staging
   on:
     push:
       branches: [main]
   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: cloudflare/wrangler-action@v3
           with:
             environment: staging
   ```
3. Create production deployment workflow (manual trigger):
   ```yaml
   # .github/workflows/deploy-production.yml
   name: Deploy Production
   on:
     workflow_dispatch:
   jobs:
     deploy:
       runs-on: ubuntu-latest
       environment: production
       steps:
         - uses: actions/checkout@v4
         - uses: cloudflare/wrangler-action@v3
           with:
             environment: production
   ```

**Acceptance Criteria**:
- [ ] Tests run automatically on PR
- [ ] Staging auto-deploys on main merge
- [ ] Production requires manual approval
- [ ] Deployment status visible in GitHub

---

## Definition of Done
- [ ] Test suite running with coverage
- [ ] All environments properly configured
- [ ] Local setup documented and streamlined
- [ ] CI/CD pipelines functional
- [ ] README updated with contribution guide

## Technical Notes
- Use Miniflare for local D1 testing
- Consider GitHub branch protection rules for main
- Store Cloudflare API token as GitHub secret

## Related Files
- `vitest.config.ts` - Test configuration (to create)
- `wrangler.toml` - Worker configuration
- `.github/workflows/` - CI/CD pipelines (to create)
- `CONTRIBUTING.md` - Developer guide (to create)
