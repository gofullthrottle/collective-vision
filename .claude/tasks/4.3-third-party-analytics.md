# Epic 4.3: Third-Party Analytics Integration

## Methodology Guidance
**SPECTRA Phase**: Implementation/Integration
**Approach**: Integrate external analytics providers
**Tools**: Google Analytics 4, Microsoft Clarity, custom pixels

## Wave Context
**Wave**: 4 - Analytics & Integrations
**Priority**: P2 (enhances insights)
**Dependencies**: Wave 0 (widget infrastructure)
**Estimated Duration**: 5 hours

## Quality Requirements
- No performance impact on widget
- Privacy/consent compliance
- Events tracked correctly
- Easy configuration in admin

---

## Tasks

### 4.3.1 Google Analytics 4 Integration (2h)
**Objective**: Send widget events to GA4

**Steps**:
1. Add analytics configuration to workspace:
   ```sql
   ALTER TABLE workspaces ADD COLUMN analytics_config TEXT;
   -- JSON: {"google_analytics": {"measurement_id": "G-XXX", "enabled": true}}
   ```

2. Create analytics loader in widget:
   ```typescript
   // src/widget/analytics.ts

   interface AnalyticsConfig {
     google_analytics?: {
       measurement_id: string;
       enabled: boolean;
     };
     clarity?: {
       project_id: string;
       enabled: boolean;
     };
     custom_pixels?: Array<{
       id: string;
       type: string;
       script: string;
       enabled: boolean;
     }>;
   }

   let analyticsLoaded = false;

   export async function initAnalytics(config: AnalyticsConfig): Promise<void> {
     if (analyticsLoaded) return;

     // Google Analytics 4
     if (config.google_analytics?.enabled && config.google_analytics.measurement_id) {
       await loadGA4(config.google_analytics.measurement_id);
     }

     // Microsoft Clarity
     if (config.clarity?.enabled && config.clarity.project_id) {
       await loadClarity(config.clarity.project_id);
     }

     analyticsLoaded = true;
   }

   async function loadGA4(measurementId: string): Promise<void> {
     // Check for consent if required
     if (window.CV_REQUIRE_CONSENT && !hasConsent('analytics')) {
       return;
     }

     // Load gtag.js
     const script = document.createElement('script');
     script.async = true;
     script.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
     document.head.appendChild(script);

     // Initialize dataLayer
     window.dataLayer = window.dataLayer || [];
     function gtag(...args: unknown[]) {
       window.dataLayer.push(args);
     }
     gtag('js', new Date());
     gtag('config', measurementId, {
       'cookie_flags': 'SameSite=None;Secure',
       'send_page_view': false  // We'll track custom events
     });

     window.cvGtag = gtag;
   }

   export function trackEvent(
     eventName: string,
     params?: Record<string, unknown>
   ): void {
     // GA4
     if (window.cvGtag) {
       window.cvGtag('event', eventName, {
         event_category: 'collective_vision',
         ...params
       });
     }

     // Clarity custom events
     if (window.clarity) {
       window.clarity('event', eventName);
     }
   }
   ```

3. Add event tracking to widget actions:
   ```typescript
   // src/widget/events.ts

   export function trackFeedbackView(boardSlug: string): void {
     trackEvent('cv_board_view', {
       board_slug: boardSlug
     });
   }

   export function trackFeedbackSubmit(feedbackId: string): void {
     trackEvent('cv_feedback_submit', {
       feedback_id: feedbackId
     });
   }

   export function trackFeedbackVote(feedbackId: string): void {
     trackEvent('cv_feedback_vote', {
       feedback_id: feedbackId
     });
   }

   export function trackWidgetOpen(): void {
     trackEvent('cv_widget_open');
   }

   export function trackWidgetClose(): void {
     trackEvent('cv_widget_close');
   }
   ```

4. Create admin config endpoint:
   ```typescript
   // PATCH /api/v1/workspaces/:id/settings/analytics
   async function handleUpdateAnalytics(request: Request, env: Env): Promise<Response> {
     const { workspaceId } = parseParams(request);
     const input = await validateBody(request, z.object({
       google_analytics: z.object({
         measurement_id: z.string().regex(/^G-[A-Z0-9]+$/),
         enabled: z.boolean()
       }).optional(),
       clarity: z.object({
         project_id: z.string(),
         enabled: z.boolean()
       }).optional()
     }));

     await requirePermission(request, env, workspaceId, 'workspace:admin');

     // Get existing config
     const workspace = await env.DB.prepare(
       'SELECT analytics_config FROM workspaces WHERE id = ?'
     ).bind(workspaceId).first();

     const existingConfig = workspace?.analytics_config
       ? JSON.parse(workspace.analytics_config as string)
       : {};

     const newConfig = {
       ...existingConfig,
       ...input
     };

     await env.DB.prepare(`
       UPDATE workspaces SET analytics_config = ?, updated_at = datetime('now')
       WHERE id = ?
     `).bind(JSON.stringify(newConfig), workspaceId).run();

     return jsonResponse({ analytics: newConfig });
   }
   ```

**Acceptance Criteria**:
- [ ] GA4 events appear in dashboard
- [ ] Consent respected
- [ ] No performance impact

---

### 4.3.2 Microsoft Clarity Integration (1.5h)
**Objective**: Enable session recordings and heatmaps

**Steps**:
1. Implement Clarity loader:
   ```typescript
   // src/widget/clarity.ts

   async function loadClarity(projectId: string): Promise<void> {
     if (window.CV_REQUIRE_CONSENT && !hasConsent('analytics')) {
       return;
     }

     // Clarity initialization script
     (function(c: Window, l: Document, a: string, r: string, i: string) {
       c[a] = c[a] || function(...args: unknown[]) {
         (c[a].q = c[a].q || []).push(args);
       };
       const t = l.createElement(r) as HTMLScriptElement;
       t.async = true;
       t.src = 'https://www.clarity.ms/tag/' + i;
       const y = l.getElementsByTagName(r)[0] as HTMLScriptElement;
       y.parentNode?.insertBefore(t, y);
     })(window, document, 'clarity', 'script', projectId);
   }

   export function clarityIdentify(userId: string): void {
     if (window.clarity) {
       window.clarity('identify', userId);
     }
   }

   export function clarityTag(key: string, value: string): void {
     if (window.clarity) {
       window.clarity('set', key, value);
     }
   }
   ```

2. Add workspace tagging:
   ```typescript
   // In widget initialization
   if (config.clarity?.enabled) {
     clarityTag('workspace', workspaceSlug);
     clarityTag('board', boardSlug);
   }
   ```

**Acceptance Criteria**:
- [ ] Clarity recording sessions
- [ ] Heatmaps visible
- [ ] No PII captured (masked by default)

---

### 4.3.3 Custom Tracking Pixel Support (1h)
**Objective**: Allow custom analytics pixels

**Steps**:
1. Create pixel configuration:
   ```typescript
   // Custom pixel schema
   const CustomPixelSchema = z.object({
     id: z.string(),
     name: z.string(),
     type: z.enum(['facebook', 'linkedin', 'custom']),
     pixel_id: z.string().optional(),  // For FB/LinkedIn
     script: z.string().optional(),     // For custom
     events: z.array(z.enum([
       'widget_open', 'feedback_submit', 'feedback_vote'
     ])),
     enabled: z.boolean()
   });
   ```

2. Implement pixel templates:
   ```typescript
   // src/widget/pixels.ts

   interface PixelConfig {
     id: string;
     type: 'facebook' | 'linkedin' | 'custom';
     pixel_id?: string;
     script?: string;
     events: string[];
     enabled: boolean;
   }

   export function loadPixels(pixels: PixelConfig[]): void {
     for (const pixel of pixels) {
       if (!pixel.enabled) continue;

       switch (pixel.type) {
         case 'facebook':
           loadFacebookPixel(pixel.pixel_id!);
           break;
         case 'linkedin':
           loadLinkedInPixel(pixel.pixel_id!);
           break;
         case 'custom':
           loadCustomPixel(pixel);
           break;
       }
     }
   }

   function loadFacebookPixel(pixelId: string): void {
     (function(f: Window, b: Document, e: string, v: string, n?: HTMLScriptElement, t?: HTMLScriptElement, s?: HTMLScriptElement) {
       if (f.fbq) return;
       n = f.fbq = function(...args: unknown[]) {
         n.callMethod ? n.callMethod(...args) : n.queue.push(args);
       };
       if (!f._fbq) f._fbq = n;
       n.push = n;
       n.loaded = true;
       n.version = '2.0';
       n.queue = [];
       t = b.createElement(e) as HTMLScriptElement;
       t.async = true;
       t.src = v;
       s = b.getElementsByTagName(e)[0] as HTMLScriptElement;
       s.parentNode?.insertBefore(t, s);
     })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
     window.fbq('init', pixelId);
   }

   function loadLinkedInPixel(partnerId: string): void {
     window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
     window._linkedin_data_partner_ids.push(partnerId);
     (function(l: Document) {
       const s = l.getElementsByTagName('script')[0] as HTMLScriptElement;
       const b = l.createElement('script') as HTMLScriptElement;
       b.type = 'text/javascript';
       b.async = true;
       b.src = 'https://snap.licdn.com/li.lms-analytics/insight.min.js';
       s.parentNode?.insertBefore(b, s);
     })(document);
   }

   function loadCustomPixel(pixel: PixelConfig): void {
     // Sandbox custom scripts using iframe
     const iframe = document.createElement('iframe');
     iframe.style.display = 'none';
     iframe.sandbox.add('allow-scripts');
     document.body.appendChild(iframe);

     const doc = iframe.contentDocument!;
     const script = doc.createElement('script');
     script.textContent = pixel.script!;
     doc.body.appendChild(script);
   }

   export function firePixelEvent(eventName: string, pixels: PixelConfig[]): void {
     for (const pixel of pixels) {
       if (!pixel.enabled || !pixel.events.includes(eventName)) continue;

       switch (pixel.type) {
         case 'facebook':
           window.fbq?.('track', mapEventToFB(eventName));
           break;
         case 'linkedin':
           window.lintrk?.('track', { conversion_id: pixel.pixel_id });
           break;
       }
     }
   }

   function mapEventToFB(eventName: string): string {
     const mapping: Record<string, string> = {
       'feedback_submit': 'Lead',
       'widget_open': 'ViewContent',
       'feedback_vote': 'Vote'
     };
     return mapping[eventName] || 'CustomEvent';
   }
   ```

**Acceptance Criteria**:
- [ ] Facebook Pixel template works
- [ ] LinkedIn Insight template works
- [ ] Custom scripts sandboxed

---

### 4.3.4 Server-Side Event Tracking (0.5h)
**Objective**: Track events server-side for reliability

**Steps**:
1. Create internal event endpoint:
   ```typescript
   // POST /api/v1/events
   async function handleTrackEvent(request: Request, env: Env): Promise<Response> {
     const input = await validateBody(request, z.object({
       event_name: z.string(),
       workspace_id: z.string(),
       properties: z.record(z.unknown()).optional(),
       client_id: z.string().optional()
     }));

     // Store event
     await env.DB.prepare(`
       INSERT INTO tracked_events (id, workspace_id, event_name, properties, client_id, created_at)
       VALUES (?, ?, ?, ?, ?, datetime('now'))
     `).bind(
       generateId('evt'),
       input.workspace_id,
       input.event_name,
       JSON.stringify(input.properties || {}),
       input.client_id
     ).run();

     // Forward to configured providers (async)
     ctx.waitUntil(forwardToAnalytics(input, env));

     return jsonResponse({ tracked: true });
   }

   async function forwardToAnalytics(
     event: { event_name: string; workspace_id: string; properties?: Record<string, unknown> },
     env: Env
   ): Promise<void> {
     const workspace = await env.DB.prepare(`
       SELECT analytics_config FROM workspaces WHERE id = ?
     `).bind(event.workspace_id).first();

     if (!workspace?.analytics_config) return;

     const config = JSON.parse(workspace.analytics_config as string) as AnalyticsConfig;

     // Forward to GA4 Measurement Protocol
     if (config.google_analytics?.enabled) {
       await fetch(`https://www.google-analytics.com/mp/collect?` +
         `measurement_id=${config.google_analytics.measurement_id}&` +
         `api_secret=${env.GA4_API_SECRET}`, {
         method: 'POST',
         body: JSON.stringify({
           client_id: event.properties?.client_id || 'server',
           events: [{
             name: event.event_name,
             params: event.properties
           }]
         })
       });
     }
   }
   ```

2. Create events table:
   ```sql
   CREATE TABLE tracked_events (
     id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL,
     event_name TEXT NOT NULL,
     properties TEXT,
     client_id TEXT,
     created_at TEXT DEFAULT (datetime('now')),
     FOREIGN KEY (workspace_id) REFERENCES workspaces(id)
   );

   CREATE INDEX idx_events_workspace ON tracked_events(workspace_id, created_at);
   ```

**Acceptance Criteria**:
- [ ] Events captured server-side
- [ ] Forwarded to GA4 via Measurement Protocol
- [ ] Queryable internally

---

## Definition of Done
- [ ] GA4 integration working
- [ ] Clarity integration working
- [ ] Custom pixel support
- [ ] Server-side tracking
- [ ] Consent handling

## Technical Notes
- GA4 Measurement Protocol requires API secret (in env)
- Clarity auto-masks PII by default
- Custom scripts sandboxed in iframe
- Check consent before loading any tracker

## Related Files
- `src/widget/analytics.ts` - Analytics loader
- `src/widget/clarity.ts` - Clarity integration
- `src/widget/pixels.ts` - Pixel management
- `src/routes/events.ts` - Server-side tracking
