# Epic 1.1: Database Schema Extensions

## Methodology Guidance
**SPECTRA Phase**: Foundation/Authentication
**Approach**: Schema-first design with proper indexing and constraints
**Tools**: D1 SQLite, Wrangler CLI

## Wave Context
**Wave**: 1 - Authentication & User Management
**Priority**: Critical (foundation for all auth features)
**Dependencies**: Wave 0 complete
**Estimated Duration**: 3 hours

## Quality Requirements
- All tables have proper foreign key constraints
- Indexes created for all frequent query patterns
- Migration can run idempotently (safe to run multiple times)
- Backward compatible with existing data

---

## Tasks

### 1.1.1 Create User Tables Migration (1h)
**Objective**: Core user authentication tables

**Steps**:
1. Create migration file `migrations/001_auth_tables.sql`:
   ```sql
   -- Users table
   CREATE TABLE IF NOT EXISTS users (
     id TEXT PRIMARY KEY,
     email TEXT UNIQUE NOT NULL,
     password_hash TEXT,
     name TEXT,
     avatar_url TEXT,
     email_verified INTEGER DEFAULT 0,
     created_at TEXT DEFAULT (datetime('now')),
     updated_at TEXT DEFAULT (datetime('now'))
   );

   -- Sessions table
   CREATE TABLE IF NOT EXISTS sessions (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     token_hash TEXT UNIQUE NOT NULL,
     expires_at TEXT NOT NULL,
     created_at TEXT DEFAULT (datetime('now'))
   );

   -- Password reset tokens
   CREATE TABLE IF NOT EXISTS password_reset_tokens (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     token_hash TEXT UNIQUE NOT NULL,
     expires_at TEXT NOT NULL,
     used INTEGER DEFAULT 0,
     created_at TEXT DEFAULT (datetime('now'))
   );

   -- Email verification tokens
   CREATE TABLE IF NOT EXISTS email_verification_tokens (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     token_hash TEXT UNIQUE NOT NULL,
     expires_at TEXT NOT NULL,
     created_at TEXT DEFAULT (datetime('now'))
   );

   -- Indexes
   CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
   CREATE INDEX IF NOT EXISTS idx_sessions_token ON sessions(token_hash);
   CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id);
   CREATE INDEX IF NOT EXISTS idx_sessions_expires ON sessions(expires_at);
   CREATE INDEX IF NOT EXISTS idx_password_reset_token ON password_reset_tokens(token_hash);
   CREATE INDEX IF NOT EXISTS idx_email_verify_token ON email_verification_tokens(token_hash);
   ```

2. Apply migration:
   ```bash
   wrangler d1 execute collective-vision-feedback --file=migrations/001_auth_tables.sql
   ```

**Acceptance Criteria**:
- [ ] Migration runs without errors
- [ ] Indexes created for email and token lookups
- [ ] Foreign key constraints enforced
- [ ] `IF NOT EXISTS` makes migration idempotent

---

### 1.1.2 Create Team Membership Tables (1h)
**Objective**: Team and role management tables

**Steps**:
1. Add to migration file `migrations/001_auth_tables.sql`:
   ```sql
   -- Team memberships (links users to workspaces with roles)
   CREATE TABLE IF NOT EXISTS team_memberships (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     workspace_id TEXT NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
     role TEXT NOT NULL DEFAULT 'member' CHECK(role IN ('owner', 'admin', 'member', 'viewer')),
     invited_by TEXT REFERENCES users(id),
     created_at TEXT DEFAULT (datetime('now')),
     UNIQUE(user_id, workspace_id)
   );

   -- Workspace invitations
   CREATE TABLE IF NOT EXISTS workspace_invitations (
     id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
     email TEXT NOT NULL,
     role TEXT NOT NULL DEFAULT 'member' CHECK(role IN ('admin', 'member', 'viewer')),
     token_hash TEXT UNIQUE NOT NULL,
     invited_by TEXT NOT NULL REFERENCES users(id),
     expires_at TEXT NOT NULL,
     accepted_at TEXT,
     created_at TEXT DEFAULT (datetime('now'))
   );

   -- Indexes
   CREATE INDEX IF NOT EXISTS idx_memberships_user ON team_memberships(user_id);
   CREATE INDEX IF NOT EXISTS idx_memberships_workspace ON team_memberships(workspace_id);
   CREATE INDEX IF NOT EXISTS idx_invitations_token ON workspace_invitations(token_hash);
   CREATE INDEX IF NOT EXISTS idx_invitations_email ON workspace_invitations(email);
   ```

**Role Hierarchy**:
- `owner`: Full control, can delete workspace, manage billing
- `admin`: Manage team, moderate feedback, change settings
- `member`: Submit and vote on feedback, view all
- `viewer`: Read-only access to feedback and analytics

**Acceptance Criteria**:
- [ ] Role enum enforced via CHECK constraint
- [ ] Unique constraint prevents duplicate memberships
- [ ] Cascade delete removes memberships when user/workspace deleted

---

### 1.1.3 Create OAuth & API Key Tables (1h)
**Objective**: OAuth provider linking and API key management

**Steps**:
1. Add OAuth accounts table:
   ```sql
   -- OAuth accounts (links external auth to users)
   CREATE TABLE IF NOT EXISTS oauth_accounts (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     provider TEXT NOT NULL CHECK(provider IN ('google', 'github')),
     provider_user_id TEXT NOT NULL,
     provider_email TEXT,
     access_token TEXT,  -- Encrypted in application
     refresh_token TEXT, -- Encrypted in application
     token_expires_at TEXT,
     created_at TEXT DEFAULT (datetime('now')),
     UNIQUE(provider, provider_user_id)
   );

   CREATE INDEX IF NOT EXISTS idx_oauth_user ON oauth_accounts(user_id);
   CREATE INDEX IF NOT EXISTS idx_oauth_provider ON oauth_accounts(provider, provider_user_id);
   ```

2. Add API keys table:
   ```sql
   -- API keys for programmatic access
   CREATE TABLE IF NOT EXISTS api_keys (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     workspace_id TEXT REFERENCES workspaces(id) ON DELETE CASCADE,
     name TEXT NOT NULL,
     key_prefix TEXT NOT NULL,  -- First 8 chars for identification (cv_live_xx)
     key_hash TEXT UNIQUE NOT NULL,  -- SHA256 hash of full key
     scopes TEXT,  -- JSON array: ["read", "write", "admin"]
     last_used_at TEXT,
     expires_at TEXT,
     revoked_at TEXT,
     created_at TEXT DEFAULT (datetime('now'))
   );

   CREATE INDEX IF NOT EXISTS idx_api_keys_hash ON api_keys(key_hash);
   CREATE INDEX IF NOT EXISTS idx_api_keys_user ON api_keys(user_id);
   CREATE INDEX IF NOT EXISTS idx_api_keys_workspace ON api_keys(workspace_id);
   ```

3. Add audit log table (for security events):
   ```sql
   -- Audit log for security events
   CREATE TABLE IF NOT EXISTS audit_logs (
     id TEXT PRIMARY KEY,
     user_id TEXT REFERENCES users(id),
     workspace_id TEXT REFERENCES workspaces(id),
     action TEXT NOT NULL,  -- login, logout, password_change, api_key_created, etc.
     resource_type TEXT,    -- user, workspace, feedback, api_key
     resource_id TEXT,
     ip_address TEXT,
     user_agent TEXT,
     details TEXT,          -- JSON with action-specific details
     created_at TEXT DEFAULT (datetime('now'))
   );

   CREATE INDEX IF NOT EXISTS idx_audit_user ON audit_logs(user_id);
   CREATE INDEX IF NOT EXISTS idx_audit_workspace ON audit_logs(workspace_id);
   CREATE INDEX IF NOT EXISTS idx_audit_created ON audit_logs(created_at);
   ```

**Acceptance Criteria**:
- [ ] OAuth accounts uniquely identified by provider + provider_user_id
- [ ] API keys store only hash (never plain key)
- [ ] Audit log captures all security-relevant events
- [ ] All indexes support query patterns

---

## Definition of Done
- [ ] All migrations run successfully
- [ ] Schema documented in `docs/database-schema.md`
- [ ] Foreign key constraints work correctly
- [ ] Indexes verified with EXPLAIN QUERY PLAN

## Technical Notes
- SQLite doesn't enforce foreign keys by default; ensure `PRAGMA foreign_keys = ON` in worker
- Token hashes use SHA256 for performance (not bcrypt)
- Passwords use bcrypt/argon2 (computed in application layer)
- Consider using ULID for primary keys for sortable IDs

## Related Files
- `schema.sql` - Base schema (existing)
- `migrations/001_auth_tables.sql` - Auth migration (to create)
- `docs/database-schema.md` - Schema documentation (to create)
